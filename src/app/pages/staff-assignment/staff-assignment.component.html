<div class="staff-assignment-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <div class="title-section">
        <h1>Staff Assignment & Patient Rounds</h1>
        <p class="subtitle">Manage staff assignments and coordinate patient care rounds</p>
      </div>
      
      <!-- Quick Actions -->
      <div class="quick-actions">
        <button 
          *ngFor="let action of quickActions" 
          mat-raised-button 
          [style.background-color]="action.color"
          (click)="action.action()"
          class="quick-action-btn">
          <app-icon [fontIcon]="action.icon" [size]="18"></app-icon>
          {{ action.label }}
        </button>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="tabs-container">
    <mat-tab-group (selectedIndexChange)="onTabChange(tabs[$event].id)">
      <mat-tab *ngFor="let tab of tabs" [label]="tab.label">
        <ng-template mat-tab-label>
          <div class="tab-label">
            <app-icon [fontIcon]="tab.icon" [size]="18"></app-icon>
            {{ tab.label }}
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    
    <!-- Staff Assignments Tab -->
    <div *ngIf="selectedTab === 'assignments'" class="assignments-tab">
      <!-- Filters and Search -->
      <div class="filters-section">
        <div class="search-box">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Search staff or patients</mat-label>
            <input matInput [(ngModel)]="searchQuery" placeholder="Type to search...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>
        
        <div class="filter-controls">
          <mat-form-field appearance="outline">
            <mat-label>Ward</mat-label>
            <mat-select [(value)]="selectedWard">
              <mat-option value="All Wards">All Wards</mat-option>
              <mat-option value="ICU">ICU</mat-option>
              <mat-option value="General">General</mat-option>
              <mat-option value="Cardiology">Cardiology</mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Role</mat-label>
            <mat-select [(value)]="selectedRole">
              <mat-option value="All Roles">All Roles</mat-option>
              <mat-option value="NURSE">Nurse</mat-option>
              <mat-option value="WARD_BOY">Ward Boy</mat-option>
              <mat-option value="CLEANING_STAFF">Cleaning Staff</mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select [(value)]="selectedStatus">
              <mat-option value="All Status">All Status</mat-option>
              <mat-option value="ACTIVE">Active</mat-option>
              <mat-option value="COMPLETED">Completed</mat-option>
              <mat-option value="ON_BREAK">On Break</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Staff and Patient Assignment Area -->
      <div class="assignment-area">
        <!-- Available Staff -->
        <div class="staff-section">
          <h3>Available Staff</h3>
          <div class="staff-grid">
            <div 
              *ngFor="let staff of getFilteredStaff()" 
              class="staff-card"
              [class.dragging]="isDragMode && draggedStaff?.id === staff.id"
              [class.unavailable]="!staff.isAvailable"
              draggable="true"
              (dragstart)="onDragStart(staff)"
              (dragend)="onDragEnd()"
              (click)="onStaffSelect(staff)">
              
              <div class="staff-avatar" [style.background-color]="getStaffColor(staff.role)">
                {{ staff.name.charAt(0) }}
              </div>
              
              <div class="staff-info">
                <h4>{{ staff.name }}</h4>
                <p class="staff-role">{{ staff.role }}</p>
                <p class="staff-department">{{ staff.department }}</p>
                <div class="staff-status">
                  <span class="status-indicator" [class.available]="staff.isAvailable"></span>
                  {{ staff.isAvailable ? 'Available' : 'Busy' }}
                </div>
                <div class="patient-load">
                  {{ staff.currentPatientCount }}/{{ staff.maxPatients }} patients
                </div>
              </div>
              
              <div class="staff-actions">
                <button mat-icon-button (click)="onStaffSelect(staff)">
                  <mat-icon>info</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Admitted Patients -->
        <div class="patients-section">
          <h3>Admitted Patients</h3>
          <div class="patients-grid">
            <div 
              *ngFor="let patient of admittedPatients" 
              class="patient-card"
              [class.drop-target]="isDragMode"
              (dragover)="$event.preventDefault()"
              (drop)="onDrop(patient)"
              (click)="onPatientSelect(patient)">
              
              <div class="patient-header">
                <h4>{{ patient.patientName }}</h4>
                <span class="patient-age">{{ patient.age }}y {{ patient.gender }}</span>
              </div>
              
              <div class="patient-details">
                <p class="patient-location">{{ patient.ward }} - Room {{ patient.room }}, Bed {{ patient.bed }}</p>
                <p class="patient-diagnosis">{{ patient.primaryDiagnosis.join(', ') }}</p>
                <div class="patient-status">
                  <span class="status-badge" [style.background-color]="getStatusColor(patient.currentStatus)">
                    {{ patient.currentStatus }}
                  </span>
                  <span class="priority-badge" [style.background-color]="getPriorityColor(patient.priority)">
                    {{ patient.priority }}
                  </span>
                </div>
              </div>
              
              <div class="assigned-staff" *ngIf="getAssignmentsForPatient(patient.patientId).length > 0">
                <h5>Assigned Staff:</h5>
                <div class="staff-chips">
                  <mat-chip *ngFor="let assignment of getAssignmentsForPatient(patient.patientId)" 
                    [style.background-color]="getStaffColor(assignment.staffRole)">
                    {{ assignment.staffName }} ({{ assignment.assignmentType }})
                  </mat-chip>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Assignments Grid -->
      <div class="assignments-grid">
        <mat-card>
          <mat-card-header>
            <mat-card-title>Current Staff Assignments</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <app-grid
              [rowData]="getFilteredAssignments()"
              [columnDefs]="staffAssignmentsColumns"
              [showHeader]="true"
              [height]="'400px'"
              [searchPlaceholder]="'Search assignments...'">
            </app-grid>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Patient Rounds Tab -->
    <div *ngIf="selectedTab === 'rounds'" class="rounds-tab">
      <!-- Round Scheduling -->
      <div class="rounds-header">
        <h3>Patient Rounds Management</h3>
        <div class="rounds-controls">
          <mat-form-field appearance="outline">
            <mat-label>Date</mat-label>
            <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate" (dateChange)="onDateChange($event.value)">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
          
          <button mat-raised-button color="primary" (click)="openRoundScheduleDialog()">
            <mat-icon>schedule</mat-icon>
            Schedule Round
          </button>
        </div>
      </div>

      <!-- Round Templates -->
      <div class="round-templates">
        <h4>Round Templates</h4>
        <div class="templates-grid">
          <mat-card *ngFor="let template of roundTemplates" class="template-card">
            <mat-card-header>
              <mat-card-title>{{ template.name }}</mat-card-title>
              <mat-card-subtitle>{{ template.roundType }} - {{ template.department }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="template-checklist">
                <h5>Checklist Items:</h5>
                <ul>
                  <li *ngFor="let item of template.checklist.slice(0, 3)">
                    {{ item.item }}
                    <span class="required" *ngIf="item.isRequired">*</span>
                  </li>
                  <li *ngIf="template.checklist.length > 3" class="more-items">
                    +{{ template.checklist.length - 3 }} more items
                  </li>
                </ul>
              </div>
              <div class="template-actions">
                <button mat-button color="primary" (click)="useTemplate(template)">
                  Use Template
                </button>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Scheduled Rounds -->
      <div class="scheduled-rounds">
        <h4>Scheduled Rounds</h4>
        <app-grid
          [rowData]="roundSchedules"
          [columnDefs]="patientRoundsColumns"
          [showHeader]="true"
          [height]="'400px'"
          [searchPlaceholder]="'Search rounds...'">
        </app-grid>
      </div>
    </div>

    <!-- Care Tasks Tab -->
    <div *ngIf="selectedTab === 'tasks'" class="tasks-tab">
      <div class="tasks-header">
        <h3>Care Tasks Management</h3>
        <button mat-raised-button color="primary" (click)="openCareTaskDialog()">
          <mat-icon>add_task</mat-icon>
          Create Task
        </button>
      </div>

      <div class="tasks-content">
        <app-grid
          [rowData]="careTasks"
          [columnDefs]="careTasksColumns"
          [showHeader]="true"
          [height]="'500px'"
          [searchPlaceholder]="'Search tasks...'">
        </app-grid>
      </div>
    </div>

    <!-- Handover Notes Tab -->
    <div *ngIf="selectedTab === 'handover'" class="handover-tab">
      <div class="handover-header">
        <h3>Handover Notes</h3>
        <button mat-raised-button color="primary" (click)="openHandoverDialog()">
          <mat-icon>swap_horiz</mat-icon>
          Create Handover
        </button>
      </div>

      <div class="handover-content">
        <app-grid
          [rowData]="handoverNotes"
          [columnDefs]="handoverNotesColumns"
          [showHeader]="true"
          [height]="'500px'"
          [searchPlaceholder]="'Search handover notes...'">
        </app-grid>
      </div>
    </div>

    <!-- Staff Roster Tab -->
    <div *ngIf="selectedTab === 'roster'" class="roster-tab">
      <div class="roster-header">
        <h3>Staff Roster</h3>
        <div class="roster-controls">
          <mat-form-field appearance="outline">
            <mat-label>Week Starting</mat-label>
            <input matInput [matDatepicker]="weekPicker" [(ngModel)]="selectedDate">
            <mat-datepicker-toggle matSuffix [for]="weekPicker"></mat-datepicker-toggle>
            <mat-datepicker #weekPicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <div class="roster-content">
        <app-grid
          [rowData]="staffRoster"
          [columnDefs]="staffRosterColumns"
          [showHeader]="true"
          [height]="'500px'"
          [searchPlaceholder]="'Search roster...'">
        </app-grid>
      </div>
    </div>

    <!-- Performance Tab -->
    <div *ngIf="selectedTab === 'performance'" class="performance-tab">
      <div class="performance-header">
        <h3>Staff Performance</h3>
        <div class="performance-controls">
          <mat-form-field appearance="outline">
            <mat-label>Period</mat-label>
            <mat-select>
              <mat-option value="week">This Week</mat-option>
              <mat-option value="month">This Month</mat-option>
              <mat-option value="quarter">This Quarter</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <div class="performance-content">
        <div class="performance-cards">
          <mat-card class="performance-card">
            <mat-card-header>
              <mat-card-title>Task Completion Rate</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="metric-value">94%</div>
              <div class="metric-trend">+2% from last period</div>
            </mat-card-content>
          </mat-card>

          <mat-card class="performance-card">
            <mat-card-header>
              <mat-card-title>On-Time Performance</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="metric-value">87%</div>
              <div class="metric-trend">+5% from last period</div>
            </mat-card-content>
          </mat-card>

          <mat-card class="performance-card">
            <mat-card-header>
              <mat-card-title>Patient Satisfaction</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="metric-value">4.6/5</div>
              <div class="metric-trend">+0.2 from last period</div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>
  </div>

  <!-- Dialogs -->
  
  <!-- Staff Assignment Dialog -->
  <div *ngIf="showStaffAssignmentDialog" class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Assign Staff to Patient</h2>
        <button mat-icon-button (click)="closeDialogs()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <form [formGroup]="staffAssignmentForm" (ngSubmit)="assignStaff()">
        <div class="dialog-body">
          <div class="form-row">
            <app-selectbox
              [label]="'Patient'"
              [options]="admittedPatients"
              [displayExpr]="'patientName'"
              [valueField]="'patientId'"
              [formGroup]="staffAssignmentForm"
              formControlName="patientId">
            </app-selectbox>
            
            <app-selectbox
              [label]="'Staff Member'"
              [options]="staffMembers"
              [displayExpr]="'name'"
              [valueField]="'id'"
              [formGroup]="staffAssignmentForm"
              formControlName="staffId">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-selectbox
              [label]="'Assignment Type'"
              [options]="['PRIMARY', 'SECONDARY', 'BACKUP', 'SPECIALIST']"
              [formGroup]="staffAssignmentForm"
              formControlName="assignmentType">
            </app-selectbox>
            
            <app-selectbox
              [label]="'Priority'"
              [options]="['LOW', 'MEDIUM', 'HIGH', 'URGENT']"
              [formGroup]="staffAssignmentForm"
              formControlName="priority">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-input
              [label]="'Shift Start'"
              [type]="'datetime-local'"
              [formGroup]="staffAssignmentForm"
              formControlName="shiftStart">
            </app-input>
            
            <app-input
              [label]="'Shift End'"
              [type]="'datetime-local'"
              [formGroup]="staffAssignmentForm"
              formControlName="shiftEnd">
            </app-input>
          </div>
          
          <div class="form-row full-width">
            <app-input
              [label]="'Notes'"
              [multiline]="true"
              [rows]="3"
              [formGroup]="staffAssignmentForm"
              formControlName="notes">
            </app-input>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button mat-button type="button" (click)="closeDialogs()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="staffAssignmentForm.invalid">
            Assign Staff
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Care Task Dialog -->
  <div *ngIf="showCareTaskDialog" class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Create Care Task</h2>
        <button mat-icon-button (click)="closeDialogs()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <form [formGroup]="careTaskForm" (ngSubmit)="createCareTask()">
        <div class="dialog-body">
          <div class="form-row">
            <app-selectbox
              [label]="'Patient'"
              [options]="admittedPatients"
              [displayExpr]="'patientName'"
              [valueField]="'patientId'"
              [formGroup]="careTaskForm"
              formControlName="patientId">
            </app-selectbox>
            
            <app-selectbox
              [label]="'Task Type'"
              [options]="['MEDICATION', 'VITALS', 'CARE', 'OBSERVATION', 'PROCEDURE', 'DOCUMENTATION', 'COMMUNICATION']"
              [formGroup]="careTaskForm"
              formControlName="taskType">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-input
              [label]="'Task Title'"
              [formGroup]="careTaskForm"
              formControlName="title">
            </app-input>
            
            <app-selectbox
              [label]="'Priority'"
              [options]="['LOW', 'MEDIUM', 'HIGH', 'URGENT']"
              [formGroup]="careTaskForm"
              formControlName="priority">
            </app-selectbox>
          </div>
          
          <div class="form-row full-width">
            <app-input
              [label]="'Description'"
              [multiline]="true"
              [rows]="3"
              [formGroup]="careTaskForm"
              formControlName="description">
            </app-input>
          </div>
          
          <div class="form-row">
            <app-selectbox
              [label]="'Assign To'"
              [options]="staffMembers"
              [displayExpr]="'name'"
              [valueField]="'id'"
              [formGroup]="careTaskForm"
              formControlName="assignedTo">
            </app-selectbox>
            
            <mat-checkbox formControlName="requiresSupervision">
              Requires Supervision
            </mat-checkbox>
          </div>
          
          <div class="form-row">
            <app-input
              [label]="'Scheduled Time'"
              [type]="'datetime-local'"
              [formGroup]="careTaskForm"
              formControlName="scheduledTime">
            </app-input>
            
            <app-input
              [label]="'Due Time'"
              [type]="'datetime-local'"
              [formGroup]="careTaskForm"
              formControlName="dueTime">
            </app-input>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button mat-button type="button" (click)="closeDialogs()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="careTaskForm.invalid">
            Create Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Handover Dialog -->
  <div *ngIf="showHandoverDialog" class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Create Handover Note</h2>
        <button mat-icon-button (click)="closeDialogs()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <form [formGroup]="handoverForm" (ngSubmit)="createHandoverNote()">
        <div class="dialog-body">
          <div class="form-row">
            <app-selectbox
              [label]="'From Staff'"
              [options]="staffMembers"
              [displayExpr]="'name'"
              [valueField]="'id'"
              [formGroup]="handoverForm"
              formControlName="fromStaffId">
            </app-selectbox>
            
            <app-selectbox
              [label]="'To Staff'"
              [options]="staffMembers"
              [displayExpr]="'name'"
              [valueField]="'id'"
              [formGroup]="handoverForm"
              formControlName="toStaffId">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-selectbox
              [label]="'Patient'"
              [options]="admittedPatients"
              [displayExpr]="'patientName'"
              [valueField]="'patientId'"
              [formGroup]="handoverForm"
              formControlName="patientId">
            </app-selectbox>
            
            <app-selectbox
              [label]="'Handover Type'"
              [options]="['SHIFT', 'BREAK', 'EMERGENCY', 'SPECIALIST']"
              [formGroup]="handoverForm"
              formControlName="handoverType">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-selectbox
              [label]="'Priority'"
              [options]="['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']"
              [formGroup]="handoverForm"
              formControlName="priority">
            </app-selectbox>
          </div>
          
          <div class="form-row full-width">
            <app-input
              [label]="'Notes'"
              [multiline]="true"
              [rows]="4"
              [formGroup]="handoverForm"
              formControlName="notes">
            </app-input>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button mat-button type="button" (click)="closeDialogs()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="handoverForm.invalid">
            Create Handover
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Round Schedule Dialog -->
  <div *ngIf="showRoundScheduleDialog" class="dialog-overlay" (click)="closeDialogs()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <div class="dialog-header">
        <h2>Schedule Patient Round</h2>
        <button mat-icon-button (click)="closeDialogs()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <form [formGroup]="roundScheduleForm" (ngSubmit)="scheduleRound()">
        <div class="dialog-body">
          <div class="form-row">
            <app-selectbox
              [label]="'Patient'"
              [options]="admittedPatients"
              [displayExpr]="'patientName'"
              [valueField]="'patientId'"
              [formGroup]="roundScheduleForm"
              formControlName="patientId">
            </app-selectbox>
            
            <app-selectbox
              [label]="'Round Type'"
              [options]="['DOCTOR_ROUND', 'NURSE_ROUND', 'CLEANING_ROUND', 'DIET_ROUND', 'PHYSIOTHERAPY_ROUND']"
              [formGroup]="roundScheduleForm"
              formControlName="roundType">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-selectbox
              [label]="'Assigned To'"
              [options]="staffMembers"
              [displayExpr]="'name'"
              [valueField]="'id'"
              [formGroup]="roundScheduleForm"
              formControlName="assignedTo">
            </app-selectbox>
            
            <app-selectbox
              [label]="'Frequency'"
              [options]="['ONCE', 'DAILY', 'TWICE_DAILY', 'EVERY_4_HOURS', 'EVERY_6_HOURS', 'WEEKLY']"
              [formGroup]="roundScheduleForm"
              formControlName="frequency">
            </app-selectbox>
          </div>
          
          <div class="form-row">
            <app-input
              [label]="'Scheduled Time'"
              [type]="'datetime-local'"
              [formGroup]="roundScheduleForm"
              formControlName="scheduledTime">
            </app-input>
            
            <app-selectbox
              [label]="'Priority'"
              [options]="['LOW', 'MEDIUM', 'HIGH', 'URGENT']"
              [formGroup]="roundScheduleForm"
              formControlName="priority">
            </app-selectbox>
          </div>
          
          <div class="form-row full-width">
            <app-input
              [label]="'Notes'"
              [multiline]="true"
              [rows]="3"
              [formGroup]="roundScheduleForm"
              formControlName="notes">
            </app-input>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button mat-button type="button" (click)="closeDialogs()">Cancel</button>
          <button mat-raised-button color="primary" type="submit" [disabled]="roundScheduleForm.invalid">
            Schedule Round
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

