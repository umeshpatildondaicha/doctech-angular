<div class="container">
  <!-- Main TabView -->
  <ul class="nav nav-tabs">
    <li
      class="nav-item"
      *ngFor="
        let tab of [
          'profile',
          'prescription',
          'overview',
          'appointments',
          'medications',
          'vitals',
          'clinical-notes',
          'lab-reports'
        ]
      "
    >
      <button
        class="nav-link"
        [ngClass]="{ active: activeTab === tab }"
        (click)="activeTab = tab"
      >
        {{ tab | titlecase }}
      </button>
    </li>
  </ul>

  <div class="tab-content pt-3">
    <!-- Profile Tab -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'profile' }"
    >
      <!-- Patient Info Card Component -->
      <app-patient-info-card 
        [patient]="patient" 
        [patientStats]="patientStats"
        [toggleAdmissionStatus]="toggleAdmissionStatus.bind(this)"
      ></app-patient-info-card>

      <br />

      <!-- IPD Management Section - Only visible for IPD patients -->
      <app-ipd-management 
        *ngIf="patient.admissionStatus === 'IPD'"
        [patient]="patient"
        [upcomingCareActivities]="upcomingCareActivities"
      ></app-ipd-management>

      <!-- Actions and Medicines Section -->
      <div
        fxLayout="row"
        fxLayoutAlign="space-between"
        style="height: 35em"
        fxLayoutGap="1em"
      >
          <mat-card
          fxFlex="50"
          class="mat-elevation-z2"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading" fxFlex="10">Types of Medicines Prescribed</div>

            <mat-card-content style="height: 100%; width: 100%; overflow: hidden;">
              <highcharts-chart
                [Highcharts]="Highcharts"
                [options]="profilePieChartOption"
                style="width: 100%; height: 100%; display: block;"
              >
              </highcharts-chart>
            </mat-card-content>
          </mat-card>

        <mat-card
          fxFlex="50"
          class="mat-elevation-z2"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
          style="overflow: hidden"
        >
          <div class="div-heading" fxFlex="10">Actions</div>
          <div 
            class="div-body" 
            fxFlex="90"
            style="overflow: hidden"
          >
            <!-- Care Schedule Timeline Component -->
            <app-care-schedule-timeline
              [careScheduleItems]="careScheduleItems"
            ></app-care-schedule-timeline>
            </div>
        </mat-card>
      </div>

      <br />

      <!-- Medical History and Timeline Section -->
      <div
        fxLayout="row"
        fxLayoutAlign="space-between"
        style="height: 30em"
        fxLayoutGap="1em"
      >
        <mat-card
          fxFlex="35"
          class="mat-elevation-z2"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading mb-0" fxFlex="10">Timeline</div>
          <div
            class="div-body p-1"
            fxFlex="90"
            style="overflow-y: auto; scrollbar-width: thin"
          >
            <!-- Timeline Component -->
            <app-patient-timeline
              [timelineData]="timelineData"
            ></app-patient-timeline>
          </div>
        </mat-card>
        <mat-card
          fxFlex="65"
          class="mat-elevation-z2"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading" fxFlex="10">Medical History</div>
          <div 
            class="div-body" 
            fxFlex="90"
            style="overflow-y: auto; overflow-x: hidden; scrollbar-width: thin"
          >
            <!-- Medical History Content -->
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Condition</th>
                    <th>Date</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of medicalHistory">
                    <td>{{ item.condition }}</td>
                    <td>{{ item.date | date }}</td>
                    <td>
                      <span
                        class="badge"
                        [ngClass]="
                          item.status === 'Resolved' ? 'bg-success' : 'bg-warning'
                        "
                      >
                        {{ item.status }}
                      </span>
                      </td>
                  </tr>
                </tbody>
                  </table>
            </div>
          </div>
        </mat-card>
      </div>
    </div>

    <!-- Prescription Tab -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'prescription' }"
    >
      <div class="card">
        <div class="card-body">
          <app-prescription-tab [patient]="patient"></app-prescription-tab>
        </div>
      </div>
    </div>

    <!-- Other Tabs -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'overview' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Medical History</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Condition</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of medicalHistory">
                  <td>{{ item.condition }}</td>
                  <td>{{ item.date | date }}</td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="
                        item.status === 'Resolved' ? 'bg-success' : 'bg-warning'
                      "
                    >
                      {{ item.status }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'appointments' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Upcoming Appointments</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Doctor</th>
                  <th>Purpose</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of appointments">
                  <td>{{ item.date | date }}</td>
                  <td>{{ item.doctor }}</td>
                  <td>{{ item.purpose }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'medications' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Current Medications</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Medicine</th>
                  <th>Dosage</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of medications">
                  <td>{{ item.medicine }}</td>
                  <td>{{ item.dosage }}</td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="
                        item.status === 'Active' ? 'bg-success' : 'bg-warning'
                      "
                    >
                      {{ item.status }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'vitals' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Vitals</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Blood Pressure</th>
                  <th>Heart Rate</th>
                  <th>Temperature</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of vitals">
                  <td>{{ item.date | date }}</td>
                  <td>{{ item.bloodPressure }}</td>
                  <td>{{ item.heartRate }}</td>
                  <td>{{ item.temperature }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Clinical Notes Tab -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'clinical-notes' }"
    >
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Clinical Notes</h5>
            <button class="btn btn-primary btn-sm">
              <i class="bi bi-plus-circle me-1"></i> Add Note
            </button>
          </div>
          
          <!-- Note Filters -->
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Search notes...">
              </div>
            </div>
            <div class="col-md-3">
              <select class="form-select">
                <option selected>All Categories</option>
                <option>Progress Notes</option>
                <option>Consultation</option>
                <option>Procedure Notes</option>
                <option>Treatment Plan</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select">
                <option selected>Most Recent</option>
                <option>Oldest First</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100">
                <i class="bi bi-filter"></i> Filter
              </button>
            </div>
          </div>
          
          <!-- Notes List -->
          <div class="clinical-notes-list">
            <div class="card mb-3 clinical-note" *ngFor="let note of clinicalNotes">
              <div class="card-header d-flex justify-content-between align-items-center py-2">
                <div>
                  <span class="badge" [ngClass]="'bg-' + note.categoryColor">{{ note.category }}</span>
                  <span class="ms-2 text-muted small">{{ note.date | date:'medium' }}</span>
                </div>
                <div>
                  <button class="btn btn-sm btn-link text-primary"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-link text-danger"><i class="bi bi-trash"></i></button>
                </div>
              </div>
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">By: {{ note.author }}</h6>
                <p class="card-text" [innerHTML]="note.content"></p>
                <div *ngIf="note.attachments && note.attachments.length > 0" class="mt-2">
                  <p class="mb-1 small"><strong>Attachments:</strong></p>
                  <div class="d-flex gap-2 flex-wrap">
                    <a *ngFor="let attachment of note.attachments" 
                       class="attachment-item d-flex align-items-center p-1 border rounded">
                      <i class="bi" [ngClass]="attachment.icon"></i>
                      <span class="ms-1 small">{{ attachment.name }}</span>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Lab Reports Tab -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'lab-reports' }"
    >
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Lab Reports</h5>
            <div>
              <button class="btn btn-primary btn-sm me-2">
                <i class="bi bi-plus-circle me-1"></i> Order New Test
              </button>
              <button class="btn btn-outline-primary btn-sm">
                <i class="bi bi-upload me-1"></i> Upload Report
              </button>
            </div>
          </div>
          
          <!-- Report Filters -->
          <div class="row mb-3">
            <div class="col-md-4">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Search reports...">
              </div>
            </div>
            <div class="col-md-3">
              <select class="form-select">
                <option selected>All Types</option>
                <option>Blood Test</option>
                <option>Urine Analysis</option>
                <option>Imaging</option>
                <option>Pathology</option>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select">
                <option selected>Most Recent</option>
                <option>Oldest First</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-outline-secondary w-100">
                <i class="bi bi-filter"></i> Filter
              </button>
            </div>
          </div>
          
          <!-- Reports List -->
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Test Name</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Results</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let report of labReports">
                  <td>{{ report.date | date }}</td>
                  <td>{{ report.name }}</td>
                  <td><span class="badge bg-info">{{ report.category }}</span></td>
                  <td>
                    <span class="badge"
                      [ngClass]="{'bg-success': report.status === 'Completed', 
                                'bg-warning': report.status === 'Pending',
                                'bg-primary': report.status === 'Ordered'}">
                      {{ report.status }}
                    </span>
                  </td>
                  <td>
                    <span *ngIf="report.abnormal" class="text-danger fw-bold">
                      <i class="bi bi-exclamation-triangle-fill me-1"></i>Abnormal
                    </span>
                    <span *ngIf="!report.abnormal && report.status === 'Completed'" class="text-success">
                      Normal
                    </span>
                    <span *ngIf="report.status !== 'Completed'">-</span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" *ngIf="report.status === 'Completed'">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary me-1" *ngIf="report.status === 'Completed'">
                      <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" *ngIf="report.status === 'Ordered'">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
