<div class="container">
  <!-- Main TabView -->
  <ul class="nav nav-tabs">
    <li
      class="nav-item"
      *ngFor="
        let tab of [
          'profile',
          'overview',
          'appointments',
          'medications',
          'vitals'
        ]
      "
    >
      <button
        class="nav-link"
        [ngClass]="{ active: activeTab === tab }"
        (click)="activeTab = tab"
      > 
        {{ tab | titlecase }}
      </button>
    </li>
  </ul>

  <div class="tab-content pt-3">
    <!-- Profile Tab -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'profile' }"
    >
      <div class="card">
        <div class="card-body">
          <div class="row">
            <!-- Patient Photo and Basic Info -->
            <div class="col-md-3 text-center h-100">
              <img
                [src]="patient.photo || 'assets/default-avatar.jpg'"
                class="rounded-circle img-thumbnail mb-3"
                alt="Patient Photo"
                style="width: 200px; height: 200px; object-fit: cover"
              />
            </div>

            <!-- Patient Details -->
            <div class="col-md-9">
              <div class="row mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-3">
                    <h4 class="mb-0">{{ patient.name }}</h4>
                    <p class="mb-0 text-muted">ID: {{ patient.id }}</p>
                  </div>
                  <div class="d-flex gap-2">
                    <a
                      href="https://wa.me/{{ patient.phone }}"
                      class="btn btn-success"
                      target="_blank"
                    >
                      <i class="bi bi-whatsapp"></i>
                    </a>
                    <a
                      href="mailto:{{ patient.email }}"
                      class="btn btn-primary"
                    >
                      <i class="bi bi-envelope"></i>
                    </a>
                  </div>
                </div>
                <div class="col">
                  <div class="d-flex gap-2">
                    <span class="badge bg-primary">{{
                      patient.patientType
                    }}</span>
                    <span class="badge bg-info">{{ patient.gender }}</span>
                    <span class="badge bg-warning"
                      >{{ patient.age }} years</span
                    >
                  </div>
                </div>
              </div>

              <!-- Medical Stats -->
              <div class="row mb-4">
                <ng-container *ngFor="let stat of patientStats">
                  <div class="col-md-3">
                    <div class="alert alert-light border">
                      <strong>{{ stat.value }}</strong> &nbsp; {{ stat.unit }}
                      <div class="d-flex">
                        {{ stat.label }}
                        <div
                          *ngIf="stat.change"
                          [ngClass]="{
                            'increment-positive': parseNumber(stat.change) > 0,
                            'increment-negative': parseNumber(stat.change) < 0
                          }"
                          class="increment"
                        >
                          <span class="icon-container">
                            <i
                              class="fa-solid"
                              [ngClass]="{
                                'fa-arrow-trend-up':
                                  parseNumber(stat.change) > 0,
                                'fa-arrow-trend-down':
                                  parseNumber(stat.change) < 0
                              }"
                            >
                            </i>
                          </span>
                          <span class="increment-text">
                            {{ parseNumber(stat.change) > 0 ? "+" : ""
                            }}{{ stat.change }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>

      <br />

      <div
        fxLayout="row"
        fxLayoutAlign="space-between"
        style="height: 35em"
        fxLayoutGap="1em"
      >
        <div
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxFlex="50"
          fxLayoutGap="1em"
          class="card-body"
        >
          <div
            fxLayout="row"
            fxLayoutAlign="space-between"
            fxFlex="70"
            class="card-body"
            fxLayoutGap="1em"
          >
            <div fxFlex="33" class="card"></div>
            <div fxFlex="33" class="card"></div>
            <div fxFlex="33" class="card"></div>
          </div>
          <div fxFlex="70" class="card pie-chart-card">
            <highcharts-chart
              [Highcharts]="Highcharts"
              [options]="profilePieChartOption"
            >
            </highcharts-chart>
          </div>
        </div>

        <div
          fxFlex="50"
          class="card"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading" fxFlex="10">Actions</div>
          <div class="div-body" fxFlex="90"></div>
        </div>
      </div>

      <br />

      <div
        fxLayout="row"
        fxLayoutAlign="space-between"
        style="height: 30em"
        fxLayoutGap="1em"
      >
        <div
          fxFlex="35"
          class="card"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading mb-0" fxFlex="10">Timeline</div>
          <div class="div-body p-1" fxFlex="90" style="overflow-y: auto; scrollbar-width: thin;">
            <div class="timeline-card shadow-none">
              <div class="timeline-item" *ngFor="let event of timelineData">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                  <div class="d-flex justify-content-between">
                    <div class="timeline-title">{{event.title}}</div>
                    <div class="timeline-date">{{event.date}}</div>
                  </div>
                  <div class="timeline-description">{{event.description}}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          fxFlex="65"
          class="card"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading" fxFlex="10">Medical History</div>
          <div class="div-body" fxFlex="90"></div>
        </div>
      </div>

      <br />

      <div
        fxLayout="row"
        fxLayoutAlign="space-between"
        style="height: 30em"
        fxLayoutGap="1em"
      >
        <div
          fxFlex="65"
          class="card"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading" fxFlex="10">Medications</div>
          <div class="div-body" fxFlex="90" style="overflow-y: auto;">
            <mat-card class="medication-card">
              <mat-card-title>Medications History</mat-card-title>
              <div class="table-container">
                <div *ngFor="let date of getUniqueAppointmentDates()">
                  <h3 class="mt-3">{{ date | date:'mediumDate' }}</h3>
                  <table mat-table [dataSource]="getMedicationsForDate(date)" class="mat-elevation-z8">
                    <!-- Medication Name -->
                    <ng-container matColumnDef="name">
                      <th mat-header-cell *matHeaderCellDef>Medication</th>
                      <td mat-cell *matCellDef="let element">{{ element.name }}</td>
                    </ng-container>
          
                    <!-- Dosage -->
                    <ng-container matColumnDef="dosage">
                      <th mat-header-cell *matHeaderCellDef>Dosage</th>
                      <td mat-cell *matCellDef="let element">{{ element.dosage }}</td>
                    </ng-container>
          
                    <!-- Frequency -->
                    <ng-container matColumnDef="frequency">
                      <th mat-header-cell *matHeaderCellDef>Frequency</th>
                      <td mat-cell *matCellDef="let element">{{ element.frequency }}</td>
                    </ng-container>
          
                    <tr mat-header-row *matHeaderRowDef="['name', 'dosage', 'frequency']"></tr>
                    <tr mat-row *matRowDef="let row; columns: ['name', 'dosage', 'frequency'];"></tr>
                  </table>
                </div>
              </div>
            </mat-card>
          </div>
          
        </div>
        <div
          fxFlex="40"
          class="card"
          fxLayout="column"
          fxLayoutAlign="space-between"
          fxLayoutGap="1em"
        >
          <div class="div-heading" fxFlex="10">Diet</div>
          <div class="div-body" fxFlex="90" style="overflow: auto;">
            <div style="height: 100%; padding: 20px;">
              <highcharts-chart 
                [Highcharts]="Highcharts" 
                [options]="dietChartOptions"
                style="width: 100%; height: 100%; display: block;">
              </highcharts-chart>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Other Tabs -->
    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'overview' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Medical History</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Condition</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of medicalHistory">
                  <td>{{ item.condition }}</td>
                  <td>{{ item.date | date }}</td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="
                        item.status === 'Resolved' ? 'bg-success' : 'bg-warning'
                      "
                    >
                      {{ item.status }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'appointments' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Upcoming Appointments</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Doctor</th>
                  <th>Purpose</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of appointments">
                  <td>{{ item.date | date }}</td>
                  <td>{{ item.doctor }}</td>
                  <td>{{ item.purpose }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'medications' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Current Medications</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Medicine</th>
                  <th>Dosage</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of medications">
                  <td>{{ item.medicine }}</td>
                  <td>{{ item.dosage }}</td>
                  <td>
                    <span
                      class="badge"
                      [ngClass]="
                        item.status === 'Active' ? 'bg-success' : 'bg-warning'
                      "
                    >
                      {{ item.status }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div
      class="tab-pane fade"
      [ngClass]="{ 'show active': activeTab === 'vitals' }"
    >
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Vitals</h5>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Blood Pressure</th>
                  <th>Heart Rate</th>
                  <th>Temperature</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of vitals">
                  <td>{{ item.date | date }}</td>
                  <td>{{ item.bloodPressure }}</td>
                  <td>{{ item.heartRate }}</td>
                  <td>{{ item.temperature }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
